<!doctype html><html><head><meta http-equiv=x-ua-compatible content="ie=edge"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Who"><meta name=keywords content="theme,kagome"><meta name=generator content="Hugo 0.103.0"><title>mq-introduction 🌟 分24期买泡面🍜</title><meta property="og:title" content="mq-introduction"><meta property="og:description" content="MQ 简述 什么是MQ 消息队列（英语：Message queue）是一种进程间通信或同一进程的不同线程间的通信方式，软件的贮列用来处理一系列的输入，"><meta property="og:type" content="article"><meta property="og:url" content="https://onlw.github.io/posts/201811230000/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-11-23T00:00:00+00:00"><meta property="article:modified_time" content="2018-11-23T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="mq-introduction"><meta name=twitter:description content="MQ 简述 什么是MQ 消息队列（英语：Message queue）是一种进程间通信或同一进程的不同线程间的通信方式，软件的贮列用来处理一系列的输入，"><link rel=stylesheet href=https://onlw.github.io/assets/css/style.min.699f46622e3574a7f9ecca4c5877067845fe89ffcd9c4335df2dff23ddae215e.css integrity="sha256-aZ9GYi41dKf57MpMWHcGeEX+if/NnEM13y3/I92uIV4="><script src=https://onlw.github.io/assets/js/main.min.182da266209851bc7c828aa7377f98f914e1e76c8decdd53a6cbe9bffea92cde.js integrity="sha256-GC2iZiCYUbx8goqnN3+Y+RTh52yN7N1Tpsvpv/6pLN4="></script></head><body><header class="header-container layout-block layout-padding"><div class="header-inner content-padding-large soft-size--large soft-style--box"><div class=header-logo><a href=https://onlw.github.io/><h1>分24期买泡面🍜</h1></a></div><nav class=header-nav><div class=header-nav--btn><div class=btn-item></div><div class=btn-item></div><div class=btn-item></div></div><div class=header-nav--list><div><a class="list-item soft-size--small soft-style--hover soft-style--active" href=/ title>HOME</a>
<a class="list-item soft-size--small soft-style--hover soft-style--active" href=/posts title>POSTS</a>
<a class="list-item soft-size--small soft-style--hover soft-style--active" href=/message title>MESSAGE</a>
<a class="list-item soft-size--small soft-style--hover soft-style--active" href=/link title>LINK</a></div></div></nav></div></header><main id=content><div class="single-container layout-block"><div class=article-info><div class="article-header layout-padding"><div class="article-cover card-container content-padding-large soft-size--large soft-style--box"><div class=card-cover></div><div class=card-text><h1 class=card-text--title>mq-introduction</h1><p class=card-text--row>2018-11-23 00:00</p><ul class=card-text--tag><li><a href=https://onlw.github.io/categories/program/>program</a></li></ul><ul class=card-text--tag><li><a href=https://onlw.github.io/tags/mq/>MQ</a></li></ul></div></div></div><div class=article-content><div class="markdown-body content-padding-large soft-size--large soft-style--box"><h2 id=mq-简述>MQ 简述</h2><h3 id=什么是mq>什么是MQ</h3><p>消息队列（英语：Message queue）是一种进程间通信或同一进程的不同线程间的通信方式，软件的贮列用来处理一系列的输入，通常是来自用户。消息队列提供了异步的通信协议，每一个贮列中的纪录包含详细说明的数据，包含发生的时间，输入设备的种类，以及特定的输入参数，也就是说：消息的发送者和接收者不需要同时与消息队列互交。消息会保存在队列中，直到接收者取回它。</p><h3 id=主流mq>主流MQ</h3><ul><li><a href=http://activemq.apache.org/ target=_blank rel=noopener>ActiveMQ</a></li><li><a href=https://www.rabbitmq.com/ target=_blank rel=noopener>RabbitMQ</a></li><li><a href=https://kafka.apache.org/ target=_blank rel=noopener>Kafka</a></li><li><a href=https://rocketmq.apache.org/ target=_blank rel=noopener>RocketMQ</a></li><li><a href=http://zeromq.org/ target=_blank rel=noopener>ZeroMQ</a></li><li></li></ul><h3 id=应用场景>应用场景</h3><p><code>当不需要立即获得结果，但是并发量又需要进行控制的时候，差不多就是需要使用消息队列的时候。</code></p><ul><li>异步处理</li><li>应用解耦</li><li>流量削峰</li><li>其他</li></ul><h3 id=使用与否>使用与否</h3><ul><li>使用</li></ul><h3 id=譬如>譬如</h3><ul><li>过安检，检测器处理能力有限，同时这些行李又不能丢了，加了个传送带，慢慢过检测器。其实这个传送带就是消息队列</li><li>用户下单后，24小时未支付，需要取消订单。以前我们可能是定时任务循环查询，然后取消订单。实际上，我更推荐类似延迟MQ的方式，避免了很多无效的数据库查询，将一个MQ设置为24小时后才让消费者消费掉，这样很大程度上能减轻服务器压力</li><li>帖子更新，关注者收到信息</li></ul><h3 id=场景举例>场景举例</h3><h4 id=异步处理>异步处理</h4><ul><li>用户提交信息注册后，网站需要给用户发送邮件和短信</li></ul><p>传统做法</p><p>将注册信息写入数据库成功后，发送注册邮件，再发送注册短信。以上三个任务全部完成后，返回给客户端</p><p><p><img src=https://upload-images.jianshu.io/upload_images/3625649-8c99197d62d75a8d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240 alt=image.png loading=lazy></p></p><p>不考虑网络等其他开销，耗费时间150ms</p><p>优化：</p><p>引入消息队列，用户的响应时间相当于是注册信息写入数据库的时间，也就是50ms。注册邮件，发送短信写入消息队列后，直接返回，因此写入消息队列的速度很快，基本可以忽略，因此用户的响应时间可能是50ms。</p><p><p><img src=https://upload-images.jianshu.io/upload_images/3625649-4e11f0cf468eae74.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240 alt=image.png loading=lazy></p></p><h3 id=应用解耦>应用解耦</h3><ul><li>凌晨进行数据统计task,这些task之间有一定的数据依赖关系</li></ul><p>task3 需要使用task2的输出作为输入，task2 需要使用task1的输出作为输入，这样的话，tast1, task2, task3之间就有任务依赖关系，必须 task1 先执行，再 task2 执行，再 task3 执行。</p><h4 id=不使用mq>不使用MQ</h4><ul><li>方案<ol><li>task1，0:00 执行，经验执行时间为 50 分钟</li><li>task2，1:00 执行（为 task1 预留 10 分钟 buffer），经验执行时间也是 50 分钟</li><li>task3，2:00 执行（为 task2 预留 10 分钟 buffer）</li></ol></li></ul><p><p><img src=https://upload-images.jianshu.io/upload_images/3625649-d91218036c0ccc6b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/740 alt=image.png loading=lazy></p></p><ul><li>问题<ol><li>如果有一个任务执行时间超过了预留 buffer 的时间，将会得到错误的结果</li><li>总任务的执行时间变长，总是要预留很多 buffer，如果前置任务提前完成，后置任务不会提前开始</li><li>如果有一个任务的执行时间要调整，将会有多个任务的执行时间要调整</li></ol></li></ul><h4 id=使用mq>使用MQ</h4><ul><li>方案<ol><li>task1 准时开始，结束后发一个“task1 done”的消息</li><li>task2 订阅 “task1 done” 的消息，收到消息后第一时间启动执行，结束后发一个 “task2 done” 的消息</li><li>task3 订阅 “task2 done” 的消息，收到消息后第一时间启动执行</li></ol></li><li>优点<ol><li>不需要预留 buffer，上游任务执行完，下游任务总会在第一时间被执行</li><li>依赖多个任务，被多个任务依赖都很好处理，只需要订阅相关消息即可</li><li>有任务执行时间变化，下游任务都不需要调整执行时间</li></ol></li></ul><p><code>MQ只用来传递上游任务执行完成的消息，并不用于传递真正的输入输出数据。</code></p><h3 id=流量削峰>流量削峰</h3><ul><li>系统A一天中大部分时间每秒请求并发数量就 100 多个，但是中午12点-1点每秒请求并发量就飙升到 10000 多个，但是系统每秒最大能处理的请求量只有 1000 多</li><li>秒杀业务：上游发起下单操作,下游完成秒杀业务逻辑（库存检查，库存冻结，余额检查，余额冻结，订单生成，余额扣减，库存扣减，生成流水，余额解冻，库存解冻）
上游下单业务简单，每秒发起了10000个请求，下游秒杀业务复杂，每秒只能处理2000个请求，很有可能上游不限速的下单，导致下游系统被压垮</li></ul><h4 id=不使用mq-1>不使用MQ</h4><p>过大流量引起服务器崩溃</p><h4 id=使用mq-1>使用MQ</h4><p><p><img src=https://upload-images.jianshu.io/upload_images/3625649-549ab8216b0dfa8e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240 alt=image.png loading=lazy></p></p><p>将非即时处理的业务逻辑进行异步化</p><h4 id=实例>实例</h4><p>某电商网站新手机发布在即，拥有预约码的用户可优先购买手机。预约方式为：注册账户即可获得预约码，预计预约用户超过1000万</p><p>像双11秒杀、手机预约抢购等对 IO 时延敏感业务环境下，当外部请求超过系统处理能力时，如果系统没有做相应保护，可能由于历史累计的超时请求负荷过多而导致系统处理的每个请求都因超时而无效，系统对外呈现的服务能力为 0，且这种情况下服务不能自动恢复。</p><p><p><img src=https://upload-images.jianshu.io/upload_images/3625649-2ff42caa2e272674.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/500 alt=image.png loading=lazy></p></p><p>这种情形下，引入MQ，将非即时处理的业务逻辑进行异步化。比如服务接收请求、处理请求和返回请求三个不同的业务逻辑。</p><p>引入 MQ 后，当预约活动开始时，海量并发访问汹涌袭来：</p><ul><li><p>所有客户的预约申请，页面均立即返回成功。客户便可关闭网页进行其他活动。预约码稍后推送到客户的邮箱/手机；</p></li><li><p>超过千万级别的注册、预约申请，先暂存在 MQ 消息队列集群；</p></li><li><p>后端服务进行处理，按照数据库实际的select、insert、update能力处理注册、预约申请；</p></li><li><p>处理成功后返回结果给用户。预约结束后，用户大约在5-30min内，都收到了预约码。</p></li></ul><h3 id=引入mq带来的问题>引入MQ带来的问题</h3><ul><li><p><strong>可用性降低</strong> 系统引入的外部依赖越多，越容易挂掉，MQ 挂掉之后会导致整个系统不可用。</p></li><li><p><strong>复杂度提高</strong> 重复消费、消息丢失、消息的顺序性等这些都是引入 MQ 之后需要考虑的事情</p></li><li><p><strong>一致性问题</strong></p><p>A 系统处理完了直接返回成功了，人都以为你这个请求就成功了；但是问题是，要是 BCD 三个系统那里，BD 两个系统写库成功了，结果 C 系统写库失败了，就会导致数据不一致</p></li></ul><h3 id=参考>参考</h3><ul><li><a href=https://blog.csdn.net/mazhifei2011/article/details/80184982 target=_blank rel=noopener>MQ消息队列选型</a></li><li></li></ul></div></div><div class=article-paging><section class="post-paging--item card-container content-padding-primary soft-size--primary soft-style--box"><div class=card-cover></div><div class=card-text><a href=/posts/201812050000/><h4 class="card-text--title text-ellipsis">zsh</h4></a><p class=card-text--row>2018-12-05 00:00</p></div></section><section class="post-paging--item card-container content-padding-primary soft-size--primary soft-style--box"><div class=card-cover></div><div class=card-text><a href=/posts/201811140000/><h4 class="card-text--title text-ellipsis">elasticsearch-build-with-docker-compose</h4></a><p class=card-text--row>2018-11-14 00:00</p></div></section></div></div><aside class=widget-info><section class="aside-widget widget-author content-padding-large soft-size--large soft-style--box"><div class=widget-body><div class="author-box avatar"><img class="author-avatar soft-size--round soft-style--box" src="https://s.gravatar.com/avatar/a0570f9d1887caa3f4e5c9df9706d15d?s=200&r=g&d=retro" alt=Who><h2 class="author-name text-ellipsis">Who</h2><p class="author-desc text-ellipsis">人类的悲欢并不相通</p></div></div></section><section class="aside-widget widget-articles content-padding-large soft-size--large soft-style--box"><h2 class=widget-header><div class=title><span>Related Posts</span></div></h2><div class=widget-body><ul class=post-list><li class=post-item><a href=/posts/202209182224/>Clickhouse Start</a></li><li class=post-item><a href=/posts/201910100000/>laravel-throttle</a></li><li class=post-item><a href=/posts/201909300000/>spring cloud config source code analysis</a></li><li class=post-item><a href=/posts/201909180000/>Load balancing</a></li><li class=post-item><a href=/posts/201909180000/>Spring Cloud Ribbon</a></li><li class=post-item><a href=/posts/201909170000/>Spring Cloud Stream</a></li></ul></div></section><section class="aside-widget widget-categories content-padding-large soft-size--large soft-style--box"><h2 class=widget-header><div class=title><span>Categories</span></div></h2><div class=widget-body><ul class=categories-list><li><a href=https://onlw.github.io/categories/program/>program</a>
<span>39</span></li><li><a href=https://onlw.github.io/categories/notes/>notes</a>
<span>4</span></li><li><a href=https://onlw.github.io/categories/default/>default</a>
<span>1</span></li><li><a href=https://onlw.github.io/categories/doc/>doc</a>
<span>1</span></li></ul></div></section><section class="aside-widget widget-tags content-padding-large soft-size--large soft-style--box"><h2 class=widget-header><div class=title><span>Tags</span></div></h2><div class=widget-body><div class=tags-list><a href=https://onlw.github.io/tags/spring-cloud/ data-count=5 class="soft-size--small soft-style--hover soft-style--active">spring-cloud</a>
<a href=https://onlw.github.io/tags/laravel/ data-count=4 class="soft-size--small soft-style--hover soft-style--active">laravel</a>
<a href=https://onlw.github.io/tags/mq/ data-count=3 class="soft-size--small soft-style--hover soft-style--active">MQ</a>
<a href=https://onlw.github.io/tags/hexo/ data-count=2 class="soft-size--small soft-style--hover soft-style--active">hexo</a>
<a href=https://onlw.github.io/tags/java/ data-count=2 class="soft-size--small soft-style--hover soft-style--active">java</a>
<a href=https://onlw.github.io/tags/kafka/ data-count=2 class="soft-size--small soft-style--hover soft-style--active">kafka</a>
<a href=https://onlw.github.io/tags/mysql/ data-count=2 class="soft-size--small soft-style--hover soft-style--active">mysql</a>
<a href=https://onlw.github.io/tags/search-engine/ data-count=2 class="soft-size--small soft-style--hover soft-style--active">search-engine</a>
<a href=https://onlw.github.io/tags/software/ data-count=2 class="soft-size--small soft-style--hover soft-style--active">software</a>
<a href=https://onlw.github.io/tags/api-gateway/ data-count=1 class="soft-size--small soft-style--hover soft-style--active">api-gateway</a>
<a href=https://onlw.github.io/tags/clickhouse/ data-count=1 class="soft-size--small soft-style--hover soft-style--active">clickhouse</a>
<a href=https://onlw.github.io/tags/composer/ data-count=1 class="soft-size--small soft-style--hover soft-style--active">composer</a></div></div><div class=widget-footer><a href=https://onlw.github.io/tags/ class="more-link center">show all<svg class="icon icon-more" width="16" height="16" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M60.928 247.808c-13.824-13.824-36.352-13.824-50.688.0-13.824 13.824-13.824 36.352.0 50.688L224.256 512 10.24 725.504c-13.824 13.824-13.824 36.352.0 50.688 7.168 7.168 15.872 10.24 25.088 10.24s18.432-3.584 25.088-10.24L299.52 537.088c13.824-13.824 13.824-36.352.0-50.688L60.928 247.808zm356.864.0c-13.824-13.824-36.352-13.824-50.688.0-13.824 13.824-13.824 36.352.0 50.688L580.608 512 367.104 725.504c-13.824 13.824-13.824 36.352.0 50.688 7.168 7.168 15.872 10.24 25.088 10.24s18.432-3.584 25.088-10.24l239.104-239.104c13.824-13.824 13.824-36.352.0-50.688L417.792 247.808zM1013.76 486.912 774.656 247.808c-13.824-13.824-36.352-13.824-50.688.0-13.824 13.824-13.824 36.352.0 50.688L937.472 512 723.968 725.504c-13.824 13.824-13.824 36.352.0 50.688 7.168 7.168 15.872 10.24 25.088 10.24s18.432-3.584 25.088-10.24l239.104-239.104c14.336-13.824 14.336-36.352.512-50.176z"/></svg></a></div></section></aside></div></main><footer class="footer-container layout-block"><div class=social-icons><a class="soft-size--primary soft-style--box" href=https://github.com/onlw target=_blank rel="noopener noreferrer"><svg class="icon icon-github" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M64.6 512c0 195.6 125.4 361.9 300.1 422.9 23.5 5.9 19.9-10.8 19.9-22.2v-77.6c-135.8 15.9-141.3-74-150.5-89-18.5-31.5-61.9-39.5-49-54.5 31-15.9 62.5 4 98.9 58 26.4 39.1 77.9 32.5 104.1 26 5.7-23.5 17.9-44.5 34.7-60.9-140.7-25.2-199.4-111.1-199.4-213.3.0-49.5 16.4-95.1 48.4-131.8-20.4-60.6 1.9-112.4 4.9-120.1 58.2-5.2 118.5 41.6 123.3 45.3 33.1-8.9 70.8-13.7 112.9-13.7 42.4.0 80.3 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.4-43.9 2.9 7.7 24.7 58.3 5.5 118.1 32.5 36.8 49 82.8 49 132.4.0 102.3-59 188.3-200.2 213.2 23.5 23.3 38.1 55.5 38.1 91.1v112.7c.8 9 0 17.9 15.1 17.9C832.7 877 960.4 709.4 960.4 512.1c0-247.5-200.6-447.9-447.9-447.9C265 64.1 64.6 264.5 64.6 512z"/></svg></a><a class="soft-size--primary soft-style--box" href target=_blank rel="noopener noreferrer"><svg class="icon icon-twitter" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M962.285714 233.142857q-38.285714 56-92.571429 95.428571.571429 8 .571429 24 0 74.285714-21.714286 148.285714t-66 142-105.428571 120.285714-147.428571 83.428571-184.571429 31.142857q-154.857143.0-283.428571-82.857143 20 2.285714 44.571429 2.285714 128.571429.0 229.142857-78.857143-60-1.142857-107.428571-36.857143t-65.142857-91.142857q18.857143 2.857143 34.857143 2.857143 24.571429.0 48.571429-6.285714-64-13.142857-106-63.714286t-42-117.428571v-2.285714q38.857143 21.714286 83.428571 23.428571-37.714286-25.142857-60-65.714286t-22.285714-88q0-50.285714 25.142857-93.142857 69.142857 85.142857 168.285714 136.285714t212.285714 56.857143q-4.571429-21.714286-4.571429-42.285714.0-76.571429 54-130.571429t130.571429-54q80 0 134.857143 58.285714 62.285714-12 117.142857-44.571429-21.142857 65.714286-81.142857 101.714286 53.142857-5.714286 106.285714-28.571429z"/></svg></a><a class="soft-size--primary soft-style--box" href target=_blank rel="noopener noreferrer"><svg class="icon icon-instagram" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M512 0C372.906667.0 355.541333.64 300.928 3.072 246.4 5.632 209.28 14.208 176.64 26.88c-33.664 13.056-62.250667 30.592-90.709333 59.050667S39.893333 142.933333 26.88 176.64C14.208 209.28 5.589333 246.4 3.072 300.928.512 355.541333.0 372.906667.0 512s.64 156.458667 3.072 211.072c2.56 54.485333 11.136 91.648 23.808 124.288a251.093333 251.093333.0 0059.050667 90.709333A250.368 250.368.0 00176.64 997.12c32.682667 12.629333 69.802667 21.290667 124.288 23.808C355.541333 1023.488 372.906667 1024 512 1024s156.458667-.64 211.072-3.072c54.485333-2.56 91.648-11.178667 124.288-23.808a251.648 251.648.0 0090.709333-59.050667A250.026667 250.026667.0 00997.12 847.36c12.629333-32.64 21.290667-69.802667 23.808-124.288 2.56-54.613333 3.072-71.978667 3.072-211.072s-.64-156.458667-3.072-211.072c-2.56-54.485333-11.178667-91.690667-23.808-124.288a251.306667 251.306667.0 00-59.050667-90.709333A249.472 249.472.0 00847.36 26.88C814.72 14.208 777.557333 5.589333 723.072 3.072 668.458667.512 651.093333.0 512 0zm0 92.16c136.661333.0 152.96.682667 206.933333 3.029333 49.92 2.346667 77.013333 10.624 95.018667 17.706667 23.978667 9.258667 40.96 20.352 58.965333 38.229333 17.877333 17.92 28.970667 34.944 38.229334 58.922667 6.997333 18.005333 15.36 45.098667 17.621333 95.018667C931.2 359.082667 931.754667 375.296 931.754667 512s-.64 152.96-3.157334 206.933333c-2.602667 49.92-10.922667 77.013333-17.962666 95.018667a162.56 162.56.0 01-38.357334 58.965333 159.744 159.744.0 01-58.88 38.229334c-17.92 6.997333-45.44 15.36-95.36 17.621333C663.68 931.2 647.68 931.754667 510.72 931.754667c-137.002667.0-153.002667-.64-207.317333-3.157334C253.44 925.994666 225.92 917.674666 208 910.634667a158.549333 158.549333.0 01-58.837333-38.357334 155.477333 155.477333.0 01-38.4-58.88c-7.04-17.92-15.317333-45.44-17.92-95.36-1.92-53.76-2.602667-70.357333-2.602667-206.677333.0-136.362667.682667-153.002667 2.602667-207.402667 2.602667-49.92 10.88-77.397333 17.92-95.317333 8.96-24.32 20.437333-40.96 38.4-58.922667C167.04 131.84 183.722667 120.32 208 111.402667 225.92 104.32 252.842667 96 302.762667 93.44c54.4-1.92 70.4-2.56 207.317333-2.56l1.92 1.28zm0 156.928a262.912 262.912.0 100 525.824 262.912 262.912.0 100-525.824zm0 433.578667c-94.293333.0-170.666667-76.373333-170.666667-170.666667S417.706666 341.333333 512 341.333333 682.666667 417.706666 682.666667 512 606.293334 682.666667 512 682.666667zM846.762667 238.72a61.482667 61.482667.0 01-122.88.0 61.44 61.44.0 01122.88.0z"/></svg></a></div><div class=colour-bar></div><p>© 2021 <a href>kagome</a>.</p><p>Powered by
<a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a>
Theme -
<a href=https://github.com/miiiku/hugo-theme-kagome target=_blank rel="noopener noreferrer author">kagome</a></p><p><a href=javascript:; id=theme-light>🌞 light</a>
<a href=javascript:; id=theme-dark>🌛 dark</a>
<a href=javascript:; id=theme-auto>🤖️ auto</a></p></footer></body></html>